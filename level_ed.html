<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Basic Template</title>
<style>
body{
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background-color: black;
  
}
canvas {
  // border: 2px solid #000;
  background-color: rgb(88,88,88);
}
</style>
</head>

<body>
<input type="file" id="fileInput" accept=".json" style="display:none">
<canvas id="canvas"></canvas>

<script>
// localStorage.removeItem("level_ed")
window.onerror = function(message, source, lineno, colno, error) {let code = localStorage.getItem("codeIDE");let getScriptLine = code => code.split("<script>")[0].split("\n").length;let ln = (getScriptLine(code)-1) + lineno;msg = message+" , line :"+ ln+" , column: " +colno+ " , " +error;let errorCursor = {"line":ln,"ch":colno,"sticky":null};localStorage.setItem("errorCursorIDE",JSON.stringify(errorCursor));alert(msg);window.close();}
function resizeCanvas() {
  var WIDTH = window.visualViewport ? window.visualViewport.width : window.innerWidth;
  var HEIGHT = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  canvas.width=WIDTH;
  canvas.height=HEIGHT;
}

// Call resizeCanvas immediately on load and bind to resize event
setTimeout(function(){resizeCanvas()},10);
window.addEventListener('resize', resizeCanvas);
project = {tileSet:null};
tiles = [];
objects = [];
buttons = [];
cur_value = null
menuRect = {
  x:0,
  y:0,
  w:canvas.width,
  h:50,
  draw:function(){
    draw_rect_ol(this.x,this.y,this.w,this.h,4,[88,88,88],[255,255,255])
  },
  loop:function(){
    this.x = 0;
    this.y = 0;
    this.w = canvas.width;
    this.h = 50;
    for(let i = 0; i < buttons.length; i++){
      buttons[i].loop();
      buttons[i].draw();
    }
  }
}
mapRect = { //mapRect.mapW
  x:0,
  y:menuRect.h,
  w:canvas.width/2,
  h:canvas.height-20,
  mapX:0,
  mapY:menuRect.h,
  mapW:10,
  mapH:10,
  mapG:16,
  draw:function(){
    if(tilesRect.sprite!=null){
      for (let y = 0; y < tiles.length; y++) {
        for (let x = 0; x < tiles[y].length; x++) {
          if(tiles[y][x]!=-1){
            let tId = tiles[y][x];
            let sx = tId%10*tilesRect.gridSize;
            let sy = floor(tId/10)*tilesRect.gridSize;
            draw_image(tilesRect.sprite,this.mapX+4+(x*this.mapG),this.mapY+4+(y*this.mapG),this.mapG,this.mapG,0,0,0,sx,sy,tilesRect.gridSize,tilesRect.gridSize)
          }
        }
      }
    }
    
    // ((selected.cellY*10)+selected.cellX)
    drawG(this.mapX+4,this.mapY+4,this.mapG,this.mapG,this.mapW*this.mapG,this.mapH*this.mapG)
    draw_set_color(255,255,255)
    draw_set_linewidth(8)
    draw_set_linedash([])
    draw_rectangle( this.x, this.y, this.w, this.h,true)
    
  },
  init:function(){
    tiles = [];
    for (let i = 0; i < this.mapH; i++) {
      var row = [];
      for (let j = 0; j < this.mapW; j++) {
        row.push(-1);
      }
      tiles.push(row);
    }
    project.tiles=tiles
    
  },
  loop:function(){
    this.x = 0;
    this.y = menuRect.h;
    this.w = canvas.width/2;
    this.h = canvas.height-menuRect.h;
    
    if(inside(mouse_x, mouse_y, this.x, this.y, this.w, this.h, 0, 0, 0)){
      this.mapG += wheelDir*1.5;
      wheelDir=0;
    if(keyboard_check(vk_up)){this.mapY -= 5}
    if(keyboard_check(vk_down)){this.mapY += 5}
    if(keyboard_check(vk_left)){this.mapX -= 5}
    if(keyboard_check(vk_right)){this.mapX += 5}
      
      let gs = this.mapG
      let mx = (floor((mouse_x-this.mapX)/gs)*gs)+this.mapX+4
      let my = (floor((mouse_y-this.mapY)/gs)*gs)+this.mapY+4
      cursor(mx,my,gs,gs,cur_value)
      mapCellX = 0;
      mapCellY = 0;
    if((mx-this.mapX-4)>0){mapCellX = (mx-this.mapX-4)/this.mapG}
    if((my-this.mapY-4)>0){mapCellY = (my-this.mapY-4)/this.mapG}
      // document.title = mapCellX+' , '+mapCellY
      if(mouse_check()){
        //drawG(this.mapX+4,this.mapY+4,this.mapG,this.mapG,this.mapW*this.mapG,this.mapH*this.mapG)
        if(mx>this.mapX && mx < this.mapX+this.mapW*this.mapG){
          if(my>this.mapY && my < this.mapY+this.mapH*this.mapG){
            tiles[mapCellY][mapCellX]=selected.tId;//((selected.cellY*10)+selected.cellX)
            project.tiles[mapCellY][mapCellX]=selected.tId;
            localStorage.setItem("level_ed", JSON.stringify(project))
          }
        }
      }
    }
  }
}
mapRect.init();
tilesRect = {
  x:canvas.width/2,
  y:menuRect.h,
  w:canvas.width/2,
  h:canvas.height-menuRect.h,
  gridSize:32,
  sprite:null,
  scale:1,
  draw:function(){
    draw_rect_ol(this.x,this.y,this.w,this.h,4,[88,88,88],[255,255,255])
    if(this.sprite!=null){
      draw_image(this.sprite,this.x+4,this.y+4,this.sprite.width*this.scale,this.sprite.height*this.scale)
      drawG(this.x+4,this.y+4,this.gridSize*this.scale,this.gridSize*this.scale,this.sprite.width*this.scale,this.sprite.height*this.scale);
      
    }
    
    
  },
  loop:function(){
    
    this.x = canvas.width/2;
    this.y = menuRect.h;
    this.w = canvas.width/2;
    this.h = canvas.height-menuRect.h;
    if(this.sprite!=null){
      if(inside(mouse_x, mouse_y, this.x, this.y, this.w, this.h, 0, 0, 0)){
        this.scale += wheelDir*0.25;
        wheelDir=0;
        let gs = this.gridSize*this.scale
        let mx = (floor((mouse_x-this.x+4)/gs)*gs)+this.x+4
      if(mx>(this.sprite.width*this.scale+this.x+4)-gs){mx = (this.sprite.width*this.scale+this.x+4)-gs}
        let my = (floor((mouse_y-this.y+4)/gs)*gs)+this.y+4
      if(my>(this.sprite.height*this.scale+this.y+4)-gs){my = (this.sprite.height*this.scale+this.y+4)-gs}
        //img.img,img.x,im.y,img.w,img.h  this.sprite
        let sx =(this.sprite.width*this.scale)
        cursor(mx,my,gs,gs,null)
        if(mouse_check_pressed()){
          selected.x=mx;
          selected.y=my;
          selected.w=gs;
          selected.h=gs;
          selected.cellX=(mx - (this.x+4))/((this.sprite.width*this.scale)/((this.sprite.width*this.scale)/(this.gridSize*this.scale)))
          selected.cellY=(my - (this.y+4))/((this.sprite.height*this.scale)/((this.sprite.height*this.scale)/(this.gridSize*this.scale)))
          selected.tId = ((selected.cellY*10)+selected.cellX)
          cur_value = this.sprite;
        }
        // document.title = mx + ' , ' + (this.sprite.width*this.scale+this.x+4)
      }
      let tId = ((selected.cellY*10)+selected.cellX)
      //document.title = 'tID = '+tId+ ' , '+floor(tId/10)+' , '+(tId % 10)
    }else{
      draw_set_color(0,0,0);
      draw_centered_text(this.x+(this.w/2), this.y+(this.h/2), "NO TILESET LOADED", this.w/20)
      draw_set_color(0,255,0);
      draw_set_linewidth(irandom(8))
      draw_rectangle(menuRect.x+4, menuRect.y+4, 120, menuRect.h-8,true,0,0,0)
    
      
    }
  }
}

selected = {
  x:0,
  y:0,
  w:0,
  h:0,
  tId:-1,
  cellX:0,
  cellY:0,
  draw:function(){
    draw_set_linewidth(1.5)
    draw_set_color(255,255,255)
    draw_set_linedash([])
    draw_rectangle(this.x, this.y, this.w, this.h,true)
    draw_set_linedash([])
  }
}
function makeButton(x,y,label,funct){
  temp = {
    x:menuRect.x+x,
    y:menuRect.y+y,
    w:120,
    h:menuRect.h-8,
    bckCol:[188,188,188],
    brdCol:[55,55,55],
    lblCol:[55,55,55],
    label:label,
    draw:function(){
      draw_rect_ol(this.x,this.y,this.w,this.h,4,this.bckCol,this.brdCol)
      draw_set_color(this.lblCol[0],this.lblCol[1],this.lblCol[2]);
      draw_centered_text(this.x+this.w/2, this.y+this.h/2, this.label, this.h/4)
    },
    loop:function(){
      this.x = menuRect.x+x;
      this.y = menuRect.y+y;
      this.w = 120;
      this.h = menuRect.h-8;
      // hover and click
      if(inside(mouse_x, mouse_y, this.x, this.y, this.w, this.h, 0, 0, 0)){// hover
        this.bckCol=[222,222,222];
        if(mouse_check_pressed()){
          eval(funct)
        }
      }else{
        this.bckCol=[188,188,188];
      }
    }
  }
  buttons.push(temp)
}

//makeButton(x,y,label,funct)
makeButton(4,4,'load tSet','loadTiles();mouse_down=false')
makeButton(124,4,'tilegrid size','tilesRect.gridSize=parseInt(prompt("enter tile size",tilesRect.gridSize));mouse_down=false')
makeButton(244,4,'mapW','mapRect.init();mapRect.mapW=parseInt(prompt("enter map width in cells",mapRect.mapW));mouse_down=false')
makeButton(364,4,'mapH','mapRect.init();mapRect.mapH=parseInt(prompt("enter map height in cells",mapRect.mapH));mouse_down=false')
makeButton(484,4,'Save Project','saveProject();mouse_down=false')
makeButton(604,4,'Load Project','load();mouse_down=false')
function start(){
  if(localStorage.getItem("level_ed")!=null){
    project=JSON.parse(localStorage.getItem("level_ed"))
    tilesRect.sprite = draw_set_image(project.tileSet)
    tiles = project.tiles;
  }
}

function loop(){
  document.title = selected.tId
if(keyboard_check_pressed(vk_delete)){selected.tId=-1;cur_value=null}
  mapRect.loop();
  menuRect.loop();
  tilesRect.loop();
  //document.title = "MOUSE X: "+mouse_x+", Y: "+mouse_y
if(keyboard_check_pressed(vk_space)){localStorage.removeItem("level_ed")}
}

function draw(){
  
  mapRect.draw();
  menuRect.draw();
  tilesRect.draw();
  selected.draw();
  //drawG(200,200,24,24,200,200)
}

function input(){
  
}
function draw_selcted(x,y,w,h){
  draw_set_linewidth(1)
  draw_set_color(0,255,0)
  draw_set_linedash([4,4])
  draw_rectangle(x, y, w, h,true)
  draw_set_linedash([])
}
function cursor(x,y,w,h,img){//selected.cellX,selected.cellY,tilesRect.sprite,tilesRect.gridSize
  if(img!=null){
    
    draw_image(img,x,y,w,h,0,0,0,tilesRect.gridSize*selected.cellX, tilesRect.gridSize*selected.cellY,tilesRect.gridSize,tilesRect.gridSize)
  }
  draw_set_linewidth(1)
  draw_set_color(255,255,255)
  draw_set_linedash([4,4])
  draw_rectangle(x, y, w, h,true)
  draw_set_linedash([])
}

function drawG(x,y,xw,yh,w,h){
  draw_set_linewidth(1)
  draw_set_alpha(1)
  draw_set_color(0,0,255)
  draw_set_linedash([4,4])
  for(let i = y; i <= y+h; i += yh){
    draw_line(x, i, x+w, i)
  }
  for(let i = x; i <= x+w; i += xw){
    draw_line(i, y, i, y+h)
  }
  draw_set_linedash([1])
  draw_set_alpha(1)
}
function draw_rect_ol(x,y,w,h,borThk,bakCol,borCol){
  draw_set_color(borCol[0],borCol[1],borCol[2])
  draw_rectangle(x,y,w,h,false,0,0,0)
  draw_set_color(bakCol[0],bakCol[1],bakCol[2])
  draw_rectangle(x+borThk,y+borThk,w-borThk*2,h-borThk*2,false,0,0,0)
}
function loadTiles(){
  var fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.multiple = true; // Enable selection of multiple files
  fileInput.addEventListener('change', function(event) {
    var files = event.target.files
    if (files[0]) {
      for(let i = 0; i < files.length; i++){
        var reader = new FileReader();
        reader.onload = function(readerEvent) {
          var fileData =  readerEvent.target.result
          tilesRect.sprite = draw_set_image(fileData)
          project.tileSet=tilesRect.sprite.src;
          localStorage.setItem("level_ed", JSON.stringify(project))
          
        };
        reader.readAsDataURL(files[i]);
      }
    }
  });
  fileInput.click();
}

function saveProject() {
  var content = JSON.stringify(project)
const blob = new Blob([content], { type: "text/json" }); // Create a Blob object with the JS content
  const url = URL.createObjectURL(blob); // Create a URL for the Blob
  const link = document.createElement("a");
  link.href = url;
  link.download = "map.json"; // Set the filename
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
function load(){
  document.getElementById('fileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file && file.type === 'application/json') {
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileContent = e.target.result;
        project = JSON.parse(fileContent);  // Display as string
        tiles = project.tiles;
      };
      reader.readAsText(file);  // Read the file content as text
    } else {
      alert('Please select a valid JSON file');
    }
  });
  document.getElementById('fileInput').click();
}
</script>
<script type='text/javascript' src='engine.js'></script>

</body>
</html>
